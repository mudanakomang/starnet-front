// 男性の理想質問配列
let womenQuestion = [{
      option: [{
        type: "prince",
        text: "かっこいい（イケメン）人"
      }, {
        type: "counselor",
        text: "優しい人"
      }, {
        type: "boy",
        text: "可愛い人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "華やかさがある人"
      }, {
        type: "counselor",
        text: "落ち着きがある人"
      }, {
        type: "boy",
        text: "少年っぽさがある人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "おしゃれな人"
      }, {
        type: "counselor",
        text: "シンプルな人"
      }, {
        type: "boy",
        text: "個性的な人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "色気がある人"
      }, {
        type: "counselor",
        text: "包容力がある人"
      }, {
        type: "boy",
        text: "母性本能をくすぐる人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "ドキドキする人"
      }, {
        type: "counselor",
        text: "安心する人"
      }, {
        type: "boy",
        text: "ハラハラさせられる人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "パワフルな人"
      }, {
        type: "counselor",
        text: "責任感がある人"
      }, {
        type: "boy",
        text: "何かしてあげたくなる人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "さわやかな人"
      }, {
        type: "counselor",
        text: "おだやかな人"
      }, {
        type: "boy",
        text: "純粋な人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "未来に展望がある人"
      }, {
        type: "counselor",
        text: "リスク回避ができる人"
      }, {
        type: "boy",
        text: "今を楽しむ人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "スポーツマン系な人"
      }, {
        type: "counselor",
        text: "インテリ系な人"
      }, {
        type: "boy",
        text: "芸術系な人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "クールな人"
      }, {
        type: "counselor",
        text: "誠実な人"
      }, {
        type: "boy",
        text: "楽天的な人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "経済力がある人"
      }, {
        type: "counselor",
        text: "人生設計がある人"
      }, {
        type: "boy",
        text: "人生を楽しんでいる人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "経営者的なタイプ"
      }, {
        type: "counselor",
        text: "大企業・公務員的なタイプ"
      }, {
        type: "boy",
        text: "自営・フリーランス的なタイプ"
      }]
    }, {
      option: [{
        type: "prince",
        text: "上昇志向の人"
      }, {
        type: "counselor",
        text: "安定志向の人"
      }, {
        type: "boy",
        text: "快適志向の人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "NO１を目指す人"
      }, {
        type: "counselor",
        text: "N0２で力を発揮する人"
      }, {
        type: "boy",
        text: "ONLY１でいたい人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "仕事ができる人"
      }, {
        type: "counselor",
        text: "頭がいい人"
      }, {
        type: "boy",
        text: "発想が豊かな人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "目立つタイプの人"
      }, {
        type: "counselor",
        text: "場を和ませる人"
      }, {
        type: "boy",
        text: "楽しませる人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "リーダーシップがある人"
      }, {
        type: "counselor",
        text: "サポート力がある人"
      }, {
        type: "boy",
        text: "ムードメーカーな人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "女性をリードしてくれる人"
      }, {
        type: "counselor",
        text: "女性を優先してくれる人"
      }, {
        type: "boy",
        text: "女性が決めやすい人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "ついていきたい人"
      }, {
        type: "counselor",
        text: "守ってくれる人"
      }, {
        type: "boy",
        text: "お互い自由な人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "専業主婦を望む人"
      }, {
        type: "counselor",
        text: "共働きを望む人"
      }, {
        type: "boy",
        text: "キャリア志向OKな人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "一緒にいて頼もしい人"
      }, {
        type: "counselor",
        text: "一緒にいて落ち着く人"
      }, {
        type: "boy",
        text: "一緒にいて気楽な人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "野望がある人"
      }, {
        type: "counselor",
        text: "地に足がついている人"
      }, {
        type: "boy",
        text: "夢がある人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "話が面白い人"
      }, {
        type: "counselor",
        text: "話を聞いてくれる人"
      }, {
        type: "boy",
        text: "話を聞いてあげたくなる人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "家事は女性に任せたいと考える人"
      }, {
        type: "counselor",
        text: "家事は分業だと考える人"
      }, {
        type: "boy",
        text: "家事は出来る事は手伝うと考える人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "仕事優先の人"
      }, {
        type: "counselor",
        text: "家庭優先の人"
      }, {
        type: "boy",
        text: "自分の趣味優先の人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "高級車・スポーツカーが好きなタイプ"
      }, {
        type: "counselor",
        text: "ファミリーカーが好きなタイプ"
      }, {
        type: "boy",
        text: "こだわりの車が好きなタイプ"
      }]
    }, {
      option: [{
        type: "prince",
        text: "ロマンチックな人"
      }, {
        type: "counselor",
        text: "常識・良識がある人"
      }, {
        type: "boy",
        text: "冒険心がある人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "チャレンジ精神旺盛な人"
      }, {
        type: "counselor",
        text: "コツコツ積み上げていく人"
      }, {
        type: "boy",
        text: "マイペースな人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "悩みは人に言いたくないタイプ"
      }, {
        type: "counselor",
        text: "悩みは相談し合うタイプ"
      }, {
        type: "boy",
        text: "悩みを自然に言ってくれるタイプ"
      }]
    }, {
      option: [{
        type: "prince",
        text: "人に尊敬されたい人"
      }, {
        type: "counselor",
        text: "人の役にたちたい人"
      }, {
        type: "boy",
        text: "人を喜ばせたい人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "ベタなエスコートが好きな人"
      }, {
        type: "counselor",
        text: "計画・準備が好きな人"
      }, {
        type: "boy",
        text: "サプライズするのが好きな人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "男らしい人"
      }, {
        type: "counselor",
        text: "温厚な人"
      }, {
        type: "boy",
        text: "茶目っ気がある人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "スピード感がある人"
      }, {
        type: "counselor",
        text: "安定感がある人"
      }, {
        type: "boy",
        text: "のんびりしている人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "気を遣ってくれないけどお金はある人"
      }, {
        type: "counselor",
        text: "気を遣ってくれるけど少し退屈な人"
      }, {
        type: "boy",
        text: "気を遣ってくれないけど一緒にいて楽しい人"
      }]
    }, {
      option: [{
        type: "prince",
        text: "ヒーロー的存在"
      }, {
        type: "counselor",
        text: "名わき役的存在"
      }, {
        type: "boy",
        text: "コメディアン的存在"
      }]
    }];

// 配列の中身をランダム化
let shuffled = womenQuestion.map(function (a) {
  return {
    weight: Math.random(),
    value: a
  }
}).sort(function (a, b) {
  return a.weight - b.weight
}).map(function (a) {
  return a.value
});

// 選択肢をランダム化
let optionShuffled = shuffled.map(function (element) {
  let optionShuffle = element.option.map(function (a) {
    return {
      weight: Math.random(),
      value: a
    }
  }).sort(function (a, b) {
    return a.weight - b.weight
  }).map(function (a) {
    return a.value
  });
  return optionShuffle
});

// テキスト更新用のカウンタ
let answerCount = 0;

// 質問番号用のカウンタ
let questionNumberCount = 1;

// 進捗用のカウンタ
let questionProguressCount = 35;

// 王子タイプ(A)のスコア
let princeScore = 0;

// カウンセラータイプ(B)のスコア
let counselorScore = 0;

// 男の子タイプ(C)のスコア
let boyScore = 0;

// 簡易判定スタートボタンを押した際の表示切替
let decisionStartButton = document.getElementById("judmentStartButton");
decisionStartButton.addEventListener('click', function () {
  document.getElementById("top").style.display = "none";
  document.getElementById("question").style.display = "block";
});

// ページ読み込んだ際に選択肢ボタンを生成、各テキストを更新
window.onload = function () {
  // html表示
  // 質問番号
  document.getElementById("questionNumber").textContent = `${questionNumberCount}`;
  // 選択肢表示
  optionShuffled[0].map(option => {
    // 選択肢のボタンを作成
    const addOptionButton = document.createElement('button');
    addOptionButton.classList.add("question-option-button");
    addOptionButton.textContent = option.text;
    addOptionButton.id = option.type;
    addOptionButton.onclick = selectOption;
    // // question-option-contentに追加
    document.getElementById("questionOptionContent").appendChild(addOptionButton);
  });
  // 終了までの質問数
  document.getElementById('questionProgressNumber').textContent = `${questionProguressCount}問`;
}

// 各選択ボタンを押した際に選択肢を再生成,各スコアを更新
function selectOption() {
  if (optionShuffled[answerCount + 1]) {
    // 質問数更新
    document.getElementById("questionNumber").textContent = `${questionNumberCount + 1}`;
    // ボタン削除
    let optionContent = document.getElementById("questionOptionContent");
    while (optionContent.firstChild) {
      optionContent.removeChild(optionContent.firstChild);
    }
    // ボタン生成
    optionShuffled[answerCount + 1].map(option => {
      // 選択肢のボタンを作成
      const addOptionButton = document.createElement('button');
      addOptionButton.classList.add("question-option-button");
      addOptionButton.textContent = option.text;
      addOptionButton.id = option.type;
      addOptionButton.onclick = selectOption;
      // question-option-contentに追加
      document.getElementById("questionOptionContent").appendChild(addOptionButton);
    });
    // 終了までの質問数更新
    document.getElementById('questionProgressNumber').textContent = `${questionProguressCount - 1}問`;
    // プログレスバー更新
    document.getElementById("questionProgressBar").value = questionNumberCount + 1;
  }

  // 各スコア更新機能
  if (answerCount == shuffled.length - 1 && this.id == "prince") {
    return princeScore = princeScore + 1, postResult();
  } else if (answerCount == shuffled.length - 1 && this.id == "counselor") {
    return counselorScore = counselorScore + 1, postResult();
  } else if (answerCount == shuffled.length - 1 && this.id == "boy") {
    return boyScore = boyScore + 1, postResult();
  } else if (this.id == "prince") {
    return princeScore = princeScore + 1, answerCount++, questionNumberCount++, questionProguressCount--;
  } else if (this.id == "counselor") {
    return counselorScore = counselorScore + 1, answerCount++, questionNumberCount++, questionProguressCount--;
  } else if (this.id == "boy") {
    return boyScore = boyScore + 1, answerCount++, questionNumberCount++, questionProguressCount--;
  }

}

// 回答結果のフロント・送信処理
function postResult() {

  // リザルト画面の表示切替
  document.getElementById("question").style.display = "none";
  document.getElementById("result").style.display = "block";

  // スコアテキストの更新
  document.getElementById("princeScore").textContent = princeScore;
  document.getElementById("counselorScore").textContent = counselorScore;
  document.getElementById("boyScore").textContent = boyScore;

  // スコア背景の円表示調整
  // 正答率算出
  function rateCalculation(score) {
    let rate = Math.round(score / 35 * 100);
    return rate;
  }

  // 王子タイプ(A)
  let princeRate = rateCalculation(princeScore);
  document.getElementById("princeScoreGraph").style.background = `conic-gradient(#3C7CBF 0, #3C7CBF ${princeRate}%, #89BDF4 ${princeRate}%, #89BDF4 100%)`;
  
  // カウンセラータイプ(B)
  let counselorRate = rateCalculation(counselorScore);
  document.getElementById("counselorScoreGraph").style.background = `conic-gradient(#2BA8C6 0,  #2BA8C6 ${counselorRate}%, #7CCDE1  ${counselorRate}%, #7CCDE1  100%)`;
  
  // 男の子タイプ(C)
  let boyRate = rateCalculation(boyScore);
  document.getElementById("boyScoreGraph").style.background = `conic-gradient(#E58E00 0, #E58E00 ${boyRate}%, #EEB75D ${boyRate}%, #EEB75D 100%)`;
  
  // userID対応
  let userID = (new URL(document.location)).searchParams.get("user_id");
  userID = userID ? userID : 1;
  
  var answerJson = {
    "user_id": userID,
    "type": 3,
    "result": [{
      "chara_type": 10,
      "chara_score": princeScore
    }, {
      "chara_type": 20,
      "chara_score": counselorScore
    }, {
      "chara_type": 40,
      "chara_score": boyScore
    }]
  };
  
  // FetchAPIのオプション準備
  const param = {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    // リクエストボディ
    body: JSON.stringify(answerJson)
  };
  //TODO: urlに関しては後ほど設定をお願い致します
  fetch("/fetch", param).then((res) => {
    console.log("res", res);
  }).then((data) => {
    console.log("data", data);
  }).catch((error) => {
    console.log("error", error);
  });
  
}