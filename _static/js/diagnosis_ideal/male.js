// 女性の理想質問配列
let maleQuestion = [{
      option: [{
        type: "princess",
        text: "女性的な人"
      }, {
        type: "secretary",
        text: "知的な人"
      }, {
        type: "mother",
        text: "優しい人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "華やかさがある人"
      }, {
        type: "secretary",
        text: "しっかりしている人"
      }, {
        type: "mother",
        text: "落ち着きがある人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "おしゃれな人"
      }, {
        type: "secretary",
        text: "シンプルな人"
      }, {
        type: "mother",
        text: "ナチュラルな人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "色気がある人"
      }, {
        type: "secretary",
        text: "仕事ができる人"
      }, {
        type: "mother",
        text: "包容力がある人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "無邪気な人"
      }, {
        type: "secretary",
        text: "気遣ってくれる人"
      }, {
        type: "mother",
        text: "癒される人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "スピーディーに行動する人"
      }, {
        type: "secretary",
        text: "無駄なく行動する人"
      }, {
        type: "mother",
        text: "慎重に行動する人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "遊び心がある人"
      }, {
        type: "secretary",
        text: "真面目な人"
      }, {
        type: "mother",
        text: "純粋な人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "今を楽しむ人"
      }, {
        type: "secretary",
        text: "未来に展望がある人"
      }, {
        type: "mother",
        text: "リスク回避ができる人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "人に評価されたい人"
      }, {
        type: "secretary",
        text: "人の役に立ちたい人"
      }, {
        type: "mother",
        text: "人のお世話をしたい人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "楽天的な人"
      }, {
        type: "secretary",
        text: "クールな人"
      }, {
        type: "mother",
        text: "誠実な人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "人生を楽しんでいる人"
      }, {
        type: "secretary",
        text: "経済力がある人"
      }, {
        type: "mother",
        text: "人生設計がある人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "特別扱いしたくなる人"
      }, {
        type: "secretary",
        text: "自立している人"
      }, {
        type: "mother",
        text: "男性を優先してくれる人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "快適志向な人"
      }, {
        type: "secretary",
        text: "上昇志向な人"
      }, {
        type: "mother",
        text: "安定志向な人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "人から憧れられる人"
      }, {
        type: "secretary",
        text: "人のために尽くす人"
      }, {
        type: "mother",
        text: "自分に尽くしてくれる人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "お金を使う能力が高い人"
      }, {
        type: "secretary",
        text: "お金を稼ぐ能力が高い人"
      }, {
        type: "mother",
        text: "お金を守る能力が高い人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "目立つ人"
      }, {
        type: "secretary",
        text: "楽しませる人"
      }, {
        type: "mother",
        text: "場を和ませる人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "ムードメーカーな人"
      }, {
        type: "secretary",
        text: "リーダーシップがある人"
      }, {
        type: "mother",
        text: "サポート力がある人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "男性を褒めてくれる人"
      }, {
        type: "secretary",
        text: "男性をたててくれる人"
      }, {
        type: "mother",
        text: "男性を優先してくれる人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "守らせてくれる人"
      }, {
        type: "secretary",
        text: "お互い自由な人"
      }, {
        type: "mother",
        text: "ついてきてくれる人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "人を明るくするタイプ"
      }, {
        type: "secretary",
        text: "人を勇ませるタイプ"
      }, {
        type: "mother",
        text: "人を癒すタイプ"
      }]
    }, {
      option: [{
        type: "princess",
        text: "一緒にいて楽しい人"
      }, {
        type: "secretary",
        text: "一緒にいて頼もしい人"
      }, {
        type: "mother",
        text: "一緒にいて落ち着く人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "夢がある人"
      }, {
        type: "secretary",
        text: "野望がある人"
      }, {
        type: "mother",
        text: "地に足がついている人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "話を聞いてあげたくなる人"
      }, {
        type: "secretary",
        text: "話が面白い人"
      }, {
        type: "mother",
        text: "話を聞いてくれる人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "怒ると感情的になる人"
      }, {
        type: "secretary",
        text: "怒ると攻撃的になる人"
      }, {
        type: "mother",
        text: "怒ると抑圧的になる人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "自分の趣味優先の人"
      }, {
        type: "secretary",
        text: "仕事優先の人"
      }, {
        type: "mother",
        text: "家庭優先の人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "決定権は女性にあると考える人"
      }, {
        type: "secretary",
        text: "決定権はお互いフェアにと考える人"
      }, {
        type: "mother",
        text: "決定権は男性にあると考える人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "ロマンチックな人"
      }, {
        type: "secretary",
        text: "冒険心がある人"
      }, {
        type: "mother",
        text: "常識・良識がある人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "短期集中タイプ"
      }, {
        type: "secretary",
        text: "チャレンジ精神旺盛なタイプ"
      }, {
        type: "mother",
        text: "コツコツ積み上げていくタイプ"
      }]
    }, {
      option: [{
        type: "princess",
        text: "悩みを沢山しゃべる人"
      }, {
        type: "secretary",
        text: "悩みを人に言いにくい人"
      }, {
        type: "mother",
        text: "悩みを溜めこむ人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "家事は男性にも協力してほしい人"
      }, {
        type: "secretary",
        text: "家事は分業が理想な人"
      }, {
        type: "mother",
        text: "家事が苦にならない人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "少女っぽさがある人"
      }, {
        type: "secretary",
        text: "姉さん女房的な人"
      }, {
        type: "mother",
        text: "家庭的な人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "高嶺の花な人"
      }, {
        type: "secretary",
        text: "サポートし合える人"
      }, {
        type: "mother",
        text: "素の自分でいられる人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "マイペースな人"
      }, {
        type: "secretary",
        text: "スピード感がある人"
      }, {
        type: "mother",
        text: "安定感がある人"
      }]
    }, {
      option: [{
        type: "princess",
        text: "女性として扱われなくなると不安になるタイプ"
      }, {
        type: "secretary",
        text: "自由がなくなると不安になるタイプ"
      }, {
        type: "mother",
        text: "将来の経済に常に不安をもつタイプ"
      }]
    }, {
      option: [{
        type: "princess",
        text: "甘えた・少女性を持つ人"
      }, {
        type: "secretary",
        text: "凛として・かっこいい人"
      }, {
        type: "mother",
        text: "気さく・気を遣わない人"
      }]
    }];

// 配列の中身をランダム化
let shuffled = maleQuestion.map(function (a) {
  return {
    weight: Math.random(),
    value: a
  }
}).sort(function (a, b) {
  return a.weight - b.weight
}).map(function (a) {
  return a.value
});

// 選択肢をランダム化
let optionShuffled = shuffled.map(function (element) {
  let optionShuffle = element.option.map(function (a) {
    return {
      weight: Math.random(),
      value: a
    }
  }).sort(function (a, b) {
    return a.weight - b.weight
  }).map(function (a) {
    return a.value
  });
  return optionShuffle
});

// テキスト更新用のカウンタ
let answerCount = 0;

// 質問番号用のカウンタ
let questionNumberCount = 1;

// 進捗用のカウンタ
let questionProguressCount = 35;

// 姫タイプ(A)のスコア
let princessScore = 0;

// 秘書タイプ(B)のスコア
let secretaryScore = 0;

// 母タイプ(C)のスコア
let motherScore = 0;

// 簡易判定スタートボタンを押した際の表示切替
let decisionStartButton = document.getElementById("judmentStartButton");
decisionStartButton.addEventListener('click', function () {
  document.getElementById("top").style.display = "none";
  document.getElementById("question").style.display = "block";
});

// ページ読み込んだ際に選択肢ボタンを生成、各テキストを更新
window.onload = function () {
  // html表示
  // 質問番号
  document.getElementById("questionNumber").textContent = `${questionNumberCount}`;
  // 選択肢表示
  optionShuffled[0].map(option => {
    // 選択肢のボタンを作成
    const addOptionButton = document.createElement('button');
    addOptionButton.classList.add("question-option-button");
    addOptionButton.textContent = option.text;
    addOptionButton.id = option.type;
    addOptionButton.onclick = selectOption;
    // // question-option-contentに追加
    document.getElementById("questionOptionContent").appendChild(addOptionButton);
  });
  // 終了までの質問数
  document.getElementById('questionProgressNumber').textContent = `${questionProguressCount}問`;
}

// 各選択ボタンを押した際に選択肢を再生成,各スコアを更新
function selectOption() {
  if (optionShuffled[answerCount + 1]) {
    // 質問数更新
    document.getElementById("questionNumber").textContent = `${questionNumberCount + 1}`;
    // ボタン削除
    let optionContent = document.getElementById("questionOptionContent");
    while (optionContent.firstChild) {
      optionContent.removeChild(optionContent.firstChild);
    }
    // ボタン生成
    optionShuffled[answerCount + 1].map(option => {
      // 選択肢のボタンを作成
      const addOptionButton = document.createElement('button');
      addOptionButton.classList.add("question-option-button");
      addOptionButton.textContent = option.text;
      addOptionButton.id = option.type;
      addOptionButton.onclick = selectOption;
      // question-option-contentに追加
      document.getElementById("questionOptionContent").appendChild(addOptionButton);
    });
    // 終了までの質問数更新
    document.getElementById('questionProgressNumber').textContent = `${questionProguressCount - 1}問`;
    // プログレスバー更新
    document.getElementById("questionProgressBar").value = questionNumberCount + 1;
  }

  // 各スコア更新機能
  if (answerCount == shuffled.length - 1 && this.id == "princess") {
    return princessScore = princessScore + 1, postResult();
  } else if (answerCount == shuffled.length - 1 && this.id == "secretary") {
    return secretaryScore = secretaryScore + 1, postResult();
  } else if (answerCount == shuffled.length - 1 && this.id == "mother") {
    return motherScore = motherScore + 1, postResult();
  } else if (this.id == "princess") {
    return princessScore = princessScore + 1, answerCount++, questionNumberCount++, questionProguressCount--;
  } else if (this.id == "secretary") {
    return secretaryScore = secretaryScore + 1, answerCount++, questionNumberCount++, questionProguressCount--;
  } else if (this.id == "mother") {
    return motherScore = motherScore + 1, answerCount++, questionNumberCount++, questionProguressCount--;
  }

}

// 回答結果のフロント・送信処理
function postResult() {

  // リザルト画面の表示切替
  document.getElementById("question").style.display = "none";
  document.getElementById("result").style.display = "block";

  // スコアテキストの更新
  document.getElementById("princessScore").textContent = princessScore;
  document.getElementById("secretaryScore").textContent = secretaryScore;
  document.getElementById("motherScore").textContent = motherScore;

  // スコア背景の円表示調整
  // 正答率算出
  function rateCalculation(score) {
    let rate = Math.round(score / 35 * 100);
    return rate;
  }

  // 姫タイプ(A)
  let princessRate = rateCalculation(princessScore);
  document.getElementById("princessScoreGraph").style.background = `conic-gradient(#F87D83 0, #F87D83 ${princessRate}%, #FEB1BE ${princessRate}%, #FEB1BE 100%)`;
  
  // 秘書タイプ(B)
  let secretaryRate = rateCalculation(secretaryScore);
  document.getElementById("secretaryScoreGraph").style.background = `conic-gradient(#2BA8C6 0,  #2BA8C6 ${secretaryRate}%, #7CCDE1  ${secretaryRate}%, #7CCDE1  100%)`;
  
  // 母タイプ(C)
  let motherRate = rateCalculation(motherScore);
  document.getElementById("motherScoreGraph").style.background = `conic-gradient(#F57325 0, #F57325 ${motherRate}%, #FFA360 ${motherRate}%, #FFA360 100%)`;
  
  // userID対応
  let userID = (new URL(document.location)).searchParams.get("user_id");
  userID = userID ? userID : 1;
  
  var answerJson = {
    "user_id": userID,
    "type": 3,
    "result": [{
      "chara_type": 1,
      "chara_score": princessScore
    }, {
      "chara_type": 2,
      "chara_score": secretaryScore
    }, {
      "chara_type": 4,
      "chara_score": motherScore
    }]
  };
  
  // FetchAPIのオプション準備
  const param = {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    // リクエストボディ
    body: JSON.stringify(answerJson)
  };
  //TODO: urlに関しては後ほど設定をお願い致します
  fetch("/fetch", param).then((res) => {
    console.log("res", res);
  }).then((data) => {
    console.log("data", data);
  }).catch((error) => {
    console.log("error", error);
  });
  
}