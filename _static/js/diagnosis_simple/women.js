// 女性版の質問配列
let womenQuestion = [{
      id: 1,
      type: "princess",
      text: "何か決める時に直感で判断することが多い"
    }, {
      id: 2,
      type: "princess",
      text: "人からの容姿、外見の評価が気になる"
    }, {
      id: 3,
      type: "princess",
      text: "聞き役よりも、話し役になる事が多い"
    }, {
      id: 4,
      type: "princess",
      text: "私は男性から優しくしてもらえるタイプだと思う"
    }, {
      id: 5,
      type: "princess",
      text: "ついイメージや想いが先行しがちだと思う"
    }, {
      id: 6,
      type: "princess",
      text: "10歳以上年上の男性とはお付き合いできない"
    }, {
      id: 7,
      type: "princess",
      text: "デートの際『何でも好きなものを食べてね』といわれると男性の評価が上がる"
    }, {
      id: 8,
      type: "princess",
      text: "美容やファッションにはお金を使っている方だと思う"
    }, {
      id: 9,
      type: "princess",
      text: "綺麗な物、可愛い物、キラキラした物を見るとつい欲しくなってしまう"
    }, {
      id: 10,
      type: "princess",
      text: "流行については、敏感な方だと思う"
    }, {
      id: 11,
      type: "princess",
      text: "男性に尽くすよりも尽くされる方が嬉しい"
    }, {
      id: 12,
      type: "princess",
      text: "幼い頃からお金にはそんなに困ってはいない"
    }, {
      id: 13,
      type: "princess",
      text: "男性の、肌や歯が綺麗でないとがっかりしてしまう"
    }, {
      id: 14,
      type: "princess",
      text: "２人の記念日を忘れられると、徐々に気持ちが冷めていく"
    }, {
      id: 15,
      type: "princess",
      text: "女性にとっての幸せは男性から愛される事だと思う"
    }, {
      id: 16,
      type: "secretary",
      text: "仕事の中でリーダー的な立場になる事が多い"
    }, {
      id: 17,
      type: "secretary",
      text: "人の役に立つ仕事をしたい"
    }, {
      id: 18,
      type: "secretary",
      text: "目標を立てて計画的にチャレンジする事は嫌いではない"
    }, {
      id: 19,
      type: "secretary",
      text: "束縛する男性とはお付き合いしたくない"
    }, {
      id: 20,
      type: "secretary",
      text: "考えた事や思った事はわりとすぐに行動できるタイプだと思う"
    }, {
      id: 21,
      type: "secretary",
      text: "男性を好きになると、気を遣い甘えられなくなる"
    }, {
      id: 22,
      type: "secretary",
      text: "人に親切にされると、その分何を返そうと考えてしまう"
    }, {
      id: 23,
      type: "secretary",
      text: "人から認められるため、つい頑張ってしまう"
    }, {
      id: 24,
      type: "secretary",
      text: "洋服やバッグを選ぶ時、可愛さよりも着心地や動きやすさ、機能性を優先する事が多い"
    }, {
      id: 25,
      type: "secretary",
      text: "勉強したり資格を取るのが好きである"
    }, {
      id: 26,
      type: "secretary",
      text: "大きな声で怒鳴られたり、偉そうに発言されると腹が立つ"
    }, {
      id: 27,
      type: "secretary",
      text: "誰かに悩みを打ち明けたり、相談に乗って貰うのはあまり得意ではない"
    }, {
      id: 28,
      type: "secretary",
      text: "男性に騙されたり，裏切られるような事を経験した事がある"
    }, {
      id: 29,
      type: "secretary",
      text: "結婚しても仕事を続けて行きたいと思っている"
    }, {
      id: 30,
      type: "secretary",
      text: "快適に生きる為には女性も経済力を身につける事が必要だと思う"
    }, {
      id: 31,
      type: "mother",
      text: "料理・洗濯・掃除などは苦にならない"
    }, {
      id: 32,
      type: "mother",
      text: "結婚はしたいと思うが今の環境が変わる事に不安がある"
    }, {
      id: 33,
      type: "mother",
      text: "結婚して経済的に安定したら、できれば働きたくない"
    }, {
      id: 34,
      type: "mother",
      text: "男性とお付き合いすると、なかなか自分から別れを切り出せない"
    }, {
      id: 35,
      type: "mother",
      text: "もしパートナーが働けなくなったら養う覚悟がある"
    }, {
      id: 36,
      type: "mother",
      text: "つい我慢してしまう傾向がある"
    }, {
      id: 37,
      type: "mother",
      text: "男性とのお付き合いが進み、相手に気を許すと、言いたい事を言ってしまう"
    }, {
      id: 38,
      type: "mother",
      text: "どちらかと言うと男性に尽くすタイプである"
    }, {
      id: 39,
      type: "mother",
      text: "「一緒にいると安心できる」と友人から言われた事がある"
    }, {
      id: 40,
      type: "mother",
      text: "親の反対を押しきってまで結婚したいとは思わない"
    }, {
      id: 41,
      type: "mother",
      text: "頼まれると嫌と言えないところがある"
    }, {
      id: 42,
      type: "mother",
      text: "友人に対する態度と、身近な家族に対する態度に差がある"
    }, {
      id: 43,
      type: "mother",
      text: "自分のわがままより相手のわがままを優先したいと思う"
    }, {
      id: 44,
      type: "mother",
      text: "パートナーの男性には、安定した仕事を求めたい"
    }, {
      id: 45,
      type: "mother",
      text: "過去に浮気されて許した事がある"
    }];

// 女性版の質問配列の中身をランダム化
let shuffled = womenQuestion.map(function (a) {
  return {
    weight: Math.random(),
    value: a
  }
}).sort(function (a, b) {
  return a.weight - b.weight
}).map(function (a) {
  return a.value
});

// テキスト更新用のカウンタ
let answerCount = 0;

// 質問番号用のカウンタ
let questionNumberCount = 1;

// 進捗用のカウンタ
let questionProguressCount = 45;

// 姫タイプのスコア
let princessScore = 0;

// 秘書タイプのスコア
let secretaryScore = 0;

// 母タイプのスコア
let motherScore = 0;

// 回答結果の配列
let answerArray = [];

// 簡易判定スタートボタンを押した際の表示切替
let decisionStartButton = document.getElementById("judmentStartButton");
decisionStartButton.addEventListener('click', function () {
  document.getElementById("top").style.display = "none";
  document.getElementById("question").style.display = "block";
});

// ページ読み込んだ際にHTMLに質問文を表示
window.onload = function () {
  // html表示
  // 質問番号
  document.getElementById("questionNumber").textContent = `${questionNumberCount}`;
  // 質問文
  document.getElementById("questionText").innerHTML = `<p>${shuffled[0].text}</p>`;
  // 終了までの質問数
  document.getElementById('questionProgressNumber').textContent = `${questionProguressCount}問`
}

// 選択肢のボタンを押した際に質問文,各スコアを更新
function selectOption() {
  if (shuffled[answerCount + 1]) {
    // 質問数更新
    document.getElementById("questionNumber").textContent = `${questionNumberCount + 1}`;
    // 質問文更新
    document.getElementById("questionText").innerHTML = `<p>${shuffled[answerCount + 1].text}</p>`;
    // 終了までの質問数更新
    document.getElementById('questionProgressNumber').textContent = `${questionProguressCount - 1}問`;
    // プログレスバー更新
    document.getElementById("questionProgressBar").value = questionNumberCount + 1;
  }
  // 各スコア更新機能
  if (this.id == "exactly") {
    if (answerCount == shuffled.length - 1 && shuffled[answerCount].type == "princess") {
      answerArray.push({
        "chara_type": 1,
        "question_id": shuffled[answerCount].id,
        "score": 10
      });
      return princessScore = princessScore + 10, postResult();
    } else if (answerCount == shuffled.length - 1 && shuffled[answerCount].type == "secretary") {
      answerArray.push({
        "chara_type": 2,
        "question_id": shuffled[answerCount].id,
        "score": 10
      });
      return secretaryScore = secretaryScore + 10, postResult();
    } else if (answerCount == shuffled.length - 1 && shuffled[answerCount].type == "mother") {
      answerArray.push({
        "chara_type": 4,
        "question_id": shuffled[answerCount].id,
        "score": 10
      });
      return motherScore = motherScore + 10, postResult();
    } else if (shuffled[answerCount].type == "princess") {
      answerArray.push({
        "chara_type": 1,
        "question_id": shuffled[answerCount].id,
        "score": 10
      });
      return princessScore = princessScore + 10, answerCount++, questionNumberCount++, questionProguressCount--;
    } else if (shuffled[answerCount].type == "secretary") {
      answerArray.push({
        "chara_type": 2,
        "question_id": shuffled[answerCount].id,
        "score": 10
      });
      return secretaryScore = secretaryScore + 10, answerCount++, questionNumberCount++, questionProguressCount--;
    } else if (shuffled[answerCount].type == "mother") {
      answerArray.push({
        "chara_type": 4,
        "question_id": shuffled[answerCount].id,
        "score": 10
      });
      return motherScore = motherScore + 10, answerCount++, questionNumberCount++, questionProguressCount--;
    }
  } else if (this.id == "notReally") {
    if (answerCount == shuffled.length - 1 && shuffled[answerCount].type == "princess") {
      answerArray.push({
        "chara_type": 1,
        "question_id": shuffled[answerCount].id,
        "score": 0
      });
      return postResult();
    } else if (answerCount == shuffled.length - 1 && shuffled[answerCount].type == "secretary") {
      answerArray.push({
        "chara_type": 2,
        "question_id": shuffled[answerCount].id,
        "score": 0
      });
      return postResult();
    } else if (answerCount == shuffled.length - 1 && shuffled[answerCount].type == "mother") {
      answerArray.push({
        "chara_type": 4,
        "question_id": shuffled[answerCount].id,
        "score": 0
      });
      return postResult();
    } else if (shuffled[answerCount].type == "princess") {
      answerArray.push({
        "chara_type": 1,
        "question_id": shuffled[answerCount].id,
        "score": 0
      });
      return answerCount++, questionNumberCount++, questionProguressCount--;
    } else if (shuffled[answerCount].type == "secretary") {
      answerArray.push({
        "chara_type": 2,
        "question_id": shuffled[answerCount].id,
        "score": 0
      });
      return answerCount++, questionNumberCount++, questionProguressCount--;
    } else if (shuffled[answerCount].type == "mother") {
      answerArray.push({
        "chara_type": 4,
        "question_id": shuffled[answerCount].id,
        "score": 0
      });
      return answerCount++, questionNumberCount++, questionProguressCount--;
    }
  } else if (this.id == "wellLikeThat") {
    if (answerCount == shuffled.length - 1 && shuffled[answerCount].type == "princess") {
      answerArray.push({
        "chara_type": 1,
        "question_id": shuffled[answerCount].id,
        "score": 5
      });
      return princessScore = princessScore + 5, postResult();
    } else if (answerCount == shuffled.length - 1 && shuffled[answerCount].type == "secretary") {
      answerArray.push({
        "chara_type": 2,
        "question_id": shuffled[answerCount].id,
        "score": 5
      });
      return secretaryScore = secretaryScore + 5, postResult();
    } else if (answerCount == shuffled.length - 1 && shuffled[answerCount].type == "mother") {
      answerArray.push({
        "chara_type": 4,
        "question_id": shuffled[answerCount].id,
        "score": 5
      });
      return motherScore = motherScore + 5, postResult();
    } else if (shuffled[answerCount].type == "princess") {
      answerArray.push({
        "chara_type": 1,
        "question_id": shuffled[answerCount].id,
        "score": 5
      });
      return princessScore = princessScore + 5, answerCount++, questionNumberCount++, questionProguressCount--;
    } else if (shuffled[answerCount].type == "secretary") {
      answerArray.push({
        "chara_type": 2,
        "question_id": shuffled[answerCount].id,
        "score": 5
      });
      return secretaryScore = secretaryScore + 5, answerCount++, questionNumberCount++, questionProguressCount--;
    } else if (shuffled[answerCount].type == "mother") {
      answerArray.push({
        "chara_type": 4,
        "question_id": shuffled[answerCount].id,
        "score": 5
      });
      return motherScore = motherScore + 5, answerCount++, questionNumberCount++, questionProguressCount--;
    }
  }

}

let exactlyButton = document.getElementById("exactly");
exactlyButton.addEventListener('click', selectOption);

let notReallyButton = document.getElementById("notReally");
notReallyButton.addEventListener('click', selectOption);

let wellLikeThatButton = document.getElementById("wellLikeThat");
wellLikeThatButton.addEventListener('click', selectOption);

// 回答結果のフロント・送信処理
function postResult() {

  // 回答の配列をquestion_id順にソート
  answerArray.sort(function (a, b) {
    if (a.question_id < b.question_id) return -1;
    if (a.question_id > b.question_id) return 1;
    return 0;
  });

  // リザルト画面の表示切替
  document.getElementById("question").style.display = "none";
  document.getElementById("result").style.display = "block";

  // スコアテキストの更新
  document.getElementById("princessScore").textContent = princessScore;
  document.getElementById("secretaryScore").textContent = secretaryScore;
  document.getElementById("motherScore").textContent = motherScore;

  // スコア背景の円表示調整
  // 正答率算出
  function rateCalculation(score) {
    let rate = Math.round(score / 150 * 100);
    return rate;
  }

  // 姫タイプ
  let princessRate = rateCalculation(princessScore);
  document.getElementById("princessScoreGraph").style.background = `conic-gradient(#F87D83 0, #F87D83 ${princessRate}%, #FEB1BE ${princessRate}%, #FEB1BE 100%)`;
  
  // 秘書タイプ
  let secretaryRate = rateCalculation(secretaryScore);
  document.getElementById("secretaryScoreGraph").style.background = `conic-gradient(#2BA8C6 0,  #2BA8C6 ${secretaryRate}%, #7CCDE1  ${secretaryRate}%, #7CCDE1  100%)`;
  
  // 母タイプ
  let motherRate = rateCalculation(motherScore);
  document.getElementById("motherScoreGraph").style.background = `conic-gradient(#F57325 0, #F57325 ${motherRate}%, #FFA360 ${motherRate}%, #FFA360 100%)`;
  
  // userID対応
  let userID = (new URL(document.location)).searchParams.get("user_id");
  userID = userID ? userID : 1;
  
  var answerJson = {
    "user_id": userID,
    "type": 1,
    "result": answerArray
  };

  // FetchAPIのオプション準備
  const param = {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    // リクエストボディ
    body: JSON.stringify(answerJson)
  };

  //TODO: urlに関しては後ほど設定をお願い致します
  fetch("/fetch", param).then((res) => {
    console.log("res", res);
  }).then((data) => {
    console.log("data", data);
  }).catch((error) => {
    console.log("error", error);
  });

}